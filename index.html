<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>A location-based game to rediscover your city</title>              
	
		<!-- Leafet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>
		<!--  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"/>  -->
        <!--Leaflet js -->    
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>
		<!--  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>   -->
		
        <!-- Turf js -->
		<script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>  
        
        <!--  NOT SURE I NEED THIS -->
		<!-- jquery -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>

        <!-- Delete @[VERSION] to allow the download of the latest version-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
		
        <!-- Set size to fit mobile browser -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />   


		<style>
			 /* set the size web page to full size */
			html, body {
				padding:0;
				margin: 0;
				width: 100%;
				height: 100%;
			}
			/* set the size of the map */
			#map {
				width: 100%;
				height: 85%;
			}

            #toggle {
				background-image: url("pics/menu_white_.png"); 
				border: none; 
				height: 33px;
				width: 35px; 
				margin-top: 37px;
				margin-right: 15px;
				position: absolute;
				top: 0;
				right: 0; 
				background-color: #467984; 
			}
			
			.figureborder { 
				border-style: solid; 
				border-color:#898989;
				padding: 2px;
				border-width: thin; 
				background-color: #DCDADA;  
			} 

            /*  NOT SURE I NEED THIS */
			/* Button style */
			button {
				background: #0084ff;
				border: none;
				border-radius: 5px;
				padding: 8px 14px;
				font-size: 15px;
				color: #fff;
			}

			#banner-message.alt {
				background: #0084ff;
				color: #fff;
				margin-top: 40px;
				width: 200px;
			}

			#banner-message.alt button {
				background: #fff;
				color: #000;
			}
		</style>
	</head>


    <!-- Set background colour --> 
    <body style="background-color: #061529"> 

        <h1 style= 'font-size: 36px; font-family: Arial; color:white; text-align:left; margin-bottom: -1px; margin-left:10px; text-shadow: 1px 1px whitesmoke'> Man_stories. A location-based game to rediscover Manchester </h1>                          
        
        <!-- Initialise the map-->
		<div id='map'></div>

		<script>

        // Set location variable to 'null' to account for no info when user just enters the game
        let loc = null;          
                    
        //Alert shown when webpage is opened
        alert("Welcome to Man_stories!\n\n\This game aims to help you explore the city by searching for hidden multimedia stories in the real-world urban environment. To continue please enable location on your device.\n\nFurther instructions are in the menu.\n\n Have fun!");      


        // Style for geofences
        const outerStyle = {      
            "color": "#2E86C1",
            "weight": 0,       //2
            "fillOpacity": 0.0   //0.1
        };

        const midStyle = {
            "color": "#2E86C1",
            "weight": 0,
            "fillOpacity": 0.0
        };

        const innerStyle = {
            "color": "#2E86C1", 
            "weight": 0, 
            "fillOpacity":0.0   //0.4 
        };

        const enterstyleIn = { 
            "color": "black",   // dark blue
            "weight": 3,
            "fillOpacity": 0.6
        };

        const enterstyleMid = { 
            "color": "#2E86C1",   // blue
            "weight": 3,
            "fillOpacity": 0.3
        };

        const enterstyleOut = { 
            "color": "red",   // light blue
            "weight": 3,
            "fillOpacity": 0.1
        };


        // Create map  
        const map = L.map('map');
        const mapCentre = L.latLng(53.4808,-2.2426);
        map.setView(mapCentre,5); //13
        // Change tiles to make the map sexier
        const Stamen_Terrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 18,
            ext: 'png'
        });
        Stamen_Terrain.addTo(map)


        // Leaflet function that tracks player's geolocation
        map.locate({setView: true, maxZoom: 14, watch: true, enableHighAccuracy: true});   


        //********************
        //GEOLOCATION FUNCTION 
        function onLocationFound(e) { 

            
            // This is the point that is getting tracked, but I do not add it to the map. 
            // Ask Abi what is the difference between 'player' and 'loc' 
            player = turf.point([e.latlng.lng, e.latlng.lat]);		 	 
            // Geolocation icon
            const playerIcon = L.icon({     
                iconUrl: 'feet.png',   // person, walk
                iconSize: [37,37],    
                iconAnchor: [17, 37],  
                popupAnchor: [0,-37],
            })
            console.log("Your current position is at:" +e.latlng);  
            // This account for the geolocation when the user just opens the game
            // I add this marker to the map
            if (loc == null) {                        
                loc = L.marker(e.latlng, {icon:playerIcon}).addTo(map);
            // Update the geolocation when the current location is known
            } else { 
                loc.setLatLng(e.latlng); 
            }

            

            //For loop to assess if current location is within outer geofence.  geof_out = outer geofence
            const outerbufferList = [bt_geof_out, eb_geof_out, ab_geof_out, bc_geof_out]; 
            const outerPopups = [bt_popup3, eb_popup3, ab_popup3, bc_popup3];  
            // 'i' is for index. Meaning that for index 0 (when we start to iterrate) when i is smaller than length, i++ is probably go one by one
            for ( let i=0; i<outerbufferList.length; i++) {
                if (turf.booleanWithin(player, outerbufferList[i])) {
                    // loc.outerPopups[i].bindPopup().openPopup();
                     outerPopups[i].openPopup();
                     // create marker object, pass custom icon as option, pass content and options to popup, add to map
                        //L.marker(e.latlng, {icon: playerIcon}).addTo(map); 
                        L.geoJSON(outerbufferList[i], {style: enterstyleOut}).addTo(map);
                } else {
                    loc.bindPopup("<strong>You are here.</strong><br />Keep exploring!.", {maxWidth: 500});
                }
            }

            //For loop to assess if current location is within middle geofence
            const midbufferList = [bt_geof_mid, eb_geof_mid, ab_geof_mid, bc_geof_mid];
            const midPopups = [bt_popup2, eb_popup2, ab_popup2, bc_popup2]; 

            for ( let i=0; i<midbufferList.length; i++) {
                if (turf.booleanWithin(player, midbufferList[i])) {
                    midPopups[i].openPopup();
                        // create marker object, pass custom icon as option, pass content and options to popup, add to map
                        //L.marker(e.latlng, {icon: playerIcon}).addTo(map); 
                        L.geoJSON(midbufferList[i], {style: enterstyleMid}).addTo(map);
                } else {
                    loc.bindPopup("<strong>You are here.</strong><br />Keep exploring!.", {maxWidth: 500});
                }
            }
            
            //For loop to assess if current location is within inner geofence.   geof = geofence; in = inner
            const innerbufferList = [bt_geof_in,eb_geof_in, ab_geof_in, bc_geof_in];
            // const innerPopups = [bt_popup1, eb_popup1];
            const popup_audio = [house_of_rising_sun, gotta_let_you_go, dont_look_back_in_anger, rhinestone_eyes]   

            for ( let i = 0; i < innerbufferList.length; i++) {       
                if (turf.booleanWithin(player, innerbufferList[i])) {					
                    popup_audio[i].addTo(map);   // .openPopup()
                            // create marker object, pass custom icon as option, pass content and options to popup, add to map
                            // L.marker(e.latlng, {icon: audioIcon}).bindPopup(customPopup, customOptions).addTo(map);       
                            L.geoJSON(innerbufferList[i], {style:enterstyleIn}).addTo(map); 			
                }  else {
                    loc.bindPopup("<strong>You are here.</strong><br />Keep exploring!.", {maxWidth: 500});
                }
            } 

           
            /*
            // SQUARE GRID******************************************************************************************
            */

            // specify units for measurement
            let gridOptions = {units: 'kilometers'};
            // get grid as a turf polygon 
            let grid = turf.squareGrid([-2.257649,53.459561,-2.220493,53.494114], 0.1, gridOptions);
            // turn grid into geoJson to display on a map
            let cover = L.geoJson(grid, {style: {color:'#000000', fill: '#89CFF0', fillOpacity: 1, weight: 0.5}}).addTo(map); 
            //console.log(cover);
            
            //Loop through each grid square
			cover.eachLayer(function(layer){

                //Get grid as a turf polygon
                let poly = turf.polygon(layer.feature.geometry.coordinates);

                //Check if avatar intersects with grid
                let ptIntersect = turf.booleanPointInPolygon(player, poly);

                //Get bounds of the grid and zoom to it
                if(ptIntersect === true){
                    
                    // Update the layer to ensure that only squares where the player is located are see-through
                    layer.setStyle({fillOpacity: 0})
                    
                }

                });
        }




        const funny = L.icon({
            iconUrl: "http://grzegorztomicki.pl/serwisy/pin.png",
            iconSize: [50, 58], // size of the icon
            iconAnchor: [20, 58], // changed marker icon position
            popupAnchor: [0, -60], // changed popup position
          });

        const walk = L.icon({
            iconUrl: "walk.png",
            iconSize: [50, 58], // size of the icon
            iconAnchor: [20, 58], // changed marker icon position
            popupAnchor: [0, -60], // changed popup position
        });

        //Icon class for custom icons 
        let manIcon = L.Icon.extend({
            options: {
                iconSize: [37,37],    
                iconAnchor: [23,37],
                popupAnchor: [-5, -37] 
            }
        });

        const dot = new manIcon({iconUrl: 'pics/dot.png'});
        

        //Site one  //backTurner bt_dot = centre point of all geofences for the Back Turner
        const bt_dot  = turf.point([-2.228104,53.490878]);    // crossroad                        // Wang Ying store = [53.487077,-2.228177]       
        const bt_geof_in = turf.buffer(bt_dot, 0.02, {units:'kilometers',steps:24}); 
        const bt_geof_mid = turf.buffer(bt_dot, 0.05, {units:'kilometers', steps:24}); 
        const bt_geof_out = turf.buffer(bt_dot, 0.1,{units: 'kilometers',steps:24});
            
        L.geoJSON(bt_geof_in,{style: innerStyle}).addTo(map); 
        L.geoJSON(bt_geof_mid, {style: midStyle}).addTo(map); 										
        L.geoJSON(bt_geof_out,{style: outerStyle}).addTo(map);	

        const bt = L.marker([53.490878,-2.228104], {icon:dot}).bindPopup().addTo(map);
   
        // Middle geofence
        const bt_popupContent2 = ("<h1 style ='text-align:center; color: #263985'> You are very close to Back Turner Street invader!</h1><b> Walk to the corner of Back Turner and Back Thomas streets to catch that wily creature.</b><iframe src='pics/01_back_turner.jpg' width='300' height='300' frameborder='0' ></iframe>")   //Add content using HTML tags 
        const bt_popup2 = bt.bindPopup(bt_popupContent2, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        // Outer geofence
        const bt_popupContent3 = ("<h1 style ='text-align:center; color: #263985'> Yeees, there are space invaders hiding here!</h1><b> It might be only one sneaky invader or might be many.</b><b> Please walk towards the centre of this circle to disocver more.</b><iframe src='pics/invader.png' width='300' height='300' frameborder='0' ></iframe>")   //Add content using HTML tags 
        const bt_popup3 = bt.bindPopup(bt_popupContent3, { 
            maxWidth: 320,				 
            maxHeight: 400
        });

        bt.off('click'); 



        //Site two //oak
        const eb_dot  = turf.point([-2.226204,53.493350]);     // Christabel   
        const eb_geof_in = turf.buffer(eb_dot, 0.02, {units:'kilometers',steps:24});
        const eb_geof_mid = turf.buffer(eb_dot, 0.05, {units:'kilometers', steps:24});   
        const eb_geof_out = turf.buffer(eb_dot, 0.1,{units: 'kilometers',steps:24});    
        var eb = L.marker([53.493350,-2.226204], {icon:dot}).bindPopup().addTo(map);  // Christabel
        
        L.geoJSON(eb_geof_in,{style: innerStyle}).addTo(map);
        L.geoJSON(eb_geof_mid, {style: midStyle}).addTo(map); 										
        L.geoJSON(eb_geof_out,{style: outerStyle}).addTo(map);				 

        // Middle geofence
        const eb_popupContent2 = ("<h1 style ='text-align:center; color: #263985'> You are very close to Engineering invader!</h1><b> Walk to the centre of the Engineering Building to catch that wily creature.</b><iframe src='pics/02_oak_street.jpg' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
        const eb_popup2 = eb.bindPopup(eb_popupContent2, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        // Outer geofence
        const eb_popupContent3 = ("<h1 style ='text-align:center; color: #263985'> Yeees, there are space invaders hiding here!</h1><b> It might be only one sneaky invader or might be many.</b><b> Please walk towards the centre of this circle to disocver more.</b><iframe src='pics/invader.png' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
        const eb_popup3 = eb.bindPopup(eb_popupContent3, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        eb.off('click'); 

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //Site three //oak
        const ab_dot  = turf.point([-2.226117,53.492234]);      // bridge  
        const ab_geof_in = turf.buffer(ab_dot, 0.02, {units:'kilometers',steps:24});
        const ab_geof_mid = turf.buffer(ab_dot, 0.05, {units:'kilometers', steps:24});   
        const ab_geof_out = turf.buffer(ab_dot, 0.1,{units: 'kilometers',steps:24});    
        var ab = L.marker([53.492234,-2.226117]).bindPopup("Oak Street Invader");   //, {icon:oak}   .addTo(map)
        L.geoJSON(ab_geof_in,{style: innerStyle}).addTo(map);
        L.geoJSON(ab_geof_mid, {style: midStyle}).addTo(map); 										
        L.geoJSON(ab_geof_out,{style: outerStyle}).addTo(map);

        // Middle geofence
        const ab_popupContent2 = ("<h1 style ='text-align:center; color: #263985'> You are very close to Engineering invader!</h1><b> Walk to the centre of the Engineering Building to catch that wily creature.</b><iframe src='pics/03_tib_street.jpg' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
        const ab_popup2 = ab.bindPopup(ab_popupContent2, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        // Outer geofence
        const ab_popupContent3 = ("<h1 style ='text-align:center; color: #263985'> Yeees, there are space invaders hiding here!</h1><b> It might be only one sneaky invader or might be many.</b><b> Please walk towards the centre of this circle to disocver more.</b><iframe src='pics/invader.png' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
        const ab_popup3 = ab.bindPopup(ab_popupContent3, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        ab.off('click'); 

                //Site four //oak
        const bc_dot  = turf.point([-2.229317,53.492024]);      // tunnel entrance
        const bc_geof_in = turf.buffer(bc_dot, 0.02, {units:'kilometers',steps:24});
        const bc_geof_mid = turf.buffer(bc_dot, 0.05, {units:'kilometers', steps:24});   
        const bc_geof_out = turf.buffer(bc_dot, 0.1,{units: 'kilometers',steps:24});    
        var bc = L.marker([53.492024,-2.229317]).bindPopup("Oak Street Invader");   //, {icon:oak}   .addTo(map)
        L.geoJSON(bc_geof_in,{style: innerStyle}).addTo(map);
        L.geoJSON(bc_geof_mid, {style: midStyle}).addTo(map); 										
        L.geoJSON(bc_geof_out,{style: outerStyle}).addTo(map);

        // Middle geofence
        const bc_popupContent2 = ("<h1 style ='text-align:center; color: #263985'> You are very close to Engineering invader!</h1><b> Walk to the centre of the Engineering Building to catch that wily creature.</b><iframe src='pics/12_canal_street.jpg' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
        const bc_popup2 = bc.bindPopup(bc_popupContent2, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        // Outer geofence
        const bc_popupContent3 = ("<h1 style ='text-align:center; color: #263985'> Yeees, there are space invaders hiding here!</h1><b> It might be only one sneaky invader or might be many.</b><b> Please walk towards the centre of this circle to disocver more.</b><iframe src='pics/invader.png' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
        const bc_popup3 = bc.bindPopup(bc_popupContent3, { 
            maxWidth: 320,				 
            maxHeight: 400
        });
        bc.off('click'); 

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Adding audio Popup
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Add a song icon
        const audioIcon = L.icon({
            iconUrl: "pinkMusic.png",
            iconSize: [50, 58], // size of the icon
            iconAnchor: [20, 58], // changed marker icon position
            popupAnchor: [0, -60], // changed popup position
        });
        

        const customPopup1 =
        //'<iframe width="360" height="310" src="https://www.youtube.com/embed/glKDhBuoRUs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
        '<b>Well done! You found Back Turner Invader!</b><br><b>Please listen to a story</b><br><iframe src="media/house_of_rising_sun.mp3" width="300" height="60" frameborder="0" ></iframe>';
        // specify popup options
        const customOptions1 = {
        maxWidth: "auto", // set max-width
        className: "customPopup", // name custom popup
        };
        const house_of_rising_sun = L.marker([53.490878,-2.228104], {icon: audioIcon}).bindPopup(customPopup1, customOptions1);
        // create popup contents

        // create popup contents
        const customPopup2 =
        //'<iframe width="360" height="310" src="https://www.youtube.com/embed/glKDhBuoRUs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
        '<b>Well done! You found Back Turner Invader!</b><br><iframe src="media/gotta_let_you_go.mp3" width="300" height="60" frameborder="0" ></iframe>';
        // specify popup options
        const customOptions2 = {
        maxWidth: "auto", // set max-width
        className: "customPopup", // name custom popup
        };
        const gotta_let_you_go = L.marker([53.493350,-2.226204], {icon: audioIcon}).bindPopup(customPopup2, customOptions2);

        // create popup contents
        const customPopup3 =
        //'<iframe width="360" height="310" src="https://www.youtube.com/embed/glKDhBuoRUs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
        '<b>Well done! You found Back Turner Invader!</b><br><iframe src="media/dont_look_back_in_anger.mp3" width="300" height="60" frameborder="0" ></iframe>';
        // specify popup options
        const customOptions3 = {
        maxWidth: "auto", // set max-width
        className: "customPopup", // name custom popup
        };
        const dont_look_back_in_anger = L.marker([53.492234,-2.226117], {icon: audioIcon}).bindPopup(customPopup3, customOptions3);

        // create popup contents
        const customPopup4 =
        //'<iframe width="360" height="310" src="https://www.youtube.com/embed/glKDhBuoRUs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
        '<b>Well done! You found Back Turner Invader!</b><br><iframe src="rhinestone_eyes.mp3" width="300" height="60" frameborder="0" ></iframe>';
        // specify popup options
        const customOptions4 = {
        maxWidth: "auto", // set max-width
        className: "customPopup", // name custom popup
        };


        const rhinestone_eyes = L.marker([53.492024,-2.229317], {icon: audioIcon}).bindPopup(customPopup4, customOptions4);




        //Call location function	
        map.on('locationfound', onLocationFound);   //onLocationFound  getPosition


        // Location error function 
        function onLocationError(e) {         
            alert(e.message); 
        } 
        map.on('locationerror', onLocationError);

        //************************************************************************************************
       // var bbox = [-96,31,-84,40];
       // var cellSide = 100;
        //var options = {units: 'meters'};

        //var hexgrid = turf.hexGrid(bbox, cellSide, options).addTo(map);
        // get the bounds of the points
        //const bbox = turf.bbox('grid_100m.json');

        // build a 100m hex grid to cover the area of interest
        //const hexgrid = turf.hexGrid(bbox, 100, {units: 'meters'}).addTo(map);
        const bbox = [-96,31,-84,40];
        const cellSide = 50;
        const options = {};
        const hexGrid = turf.hexGrid(bbox, cellSide, options);
        hexGrid.features.forEach(f => {
        f.properties = { density: Math.random() };  
        });

        map.on('load', function () {

            map.addLayer({
                'id': 'maine',
                'type': 'fill',
                'source': {
                    'type': 'geojson',
                    'data': hexGrid
                },
                'layout': {},
                'paint': {
                    'fill-color': '#088',
                    'fill-opacity': [
                    "interpolate", ["linear"], ["get", "density"],
                    0, 0.3,
                    1, 1
                    ]
                }
            });
        });











        </script>
    </body>
</html>
